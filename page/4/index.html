<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yoursite.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="A place for codeing break.">
<meta property="og:type" content="website">
<meta property="og:title" content="Carlmartin&#39; Blog">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="Carlmartin&#39; Blog">
<meta property="og:description" content="A place for codeing break.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Carlmartin">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yoursite.com/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Carlmartin' Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Carlmartin' Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">In me the tiger sniffs the rose.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Carlmartin</p>
  <div class="site-description" itemprop="description">A place for codeing break.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">57</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/18/%E8%BD%AC-OAuth%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Carlmartin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carlmartin' Blog">
      <meta itemprop="description" content="A place for codeing break.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Carlmartin' Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/18/%E8%BD%AC-OAuth%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">[转]OAuth学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-18 11:55:59" itemprop="dateCreated datePublished" datetime="2019-08-18T11:55:59+08:00">2019-08-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-06 16:19:03" itemprop="dateModified" datetime="2024-03-06T16:19:03+08:00">2024-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BD%AC%E8%BD%BD%E6%96%87%E7%AB%A0/" itemprop="url" rel="index"><span itemprop="name">转载文章</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p> <a href="http://www.ruanyifeng.com/blog/2019/04/oauth_design.html">文章转载自此</a></p>
</blockquote>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>简单说，OAuth 就是一种<strong>授权机制</strong>。数据的所有者告诉系统，同意授权第三方应用进入系统，获取这些数据。系统从而产生一个短期的进入令牌（token），用来代替密码，供第三方应用使用</p>
<p>平时我们遇到的使用微信授权登录, 就是OAuth的一个应用. 在国外经常使用github或者google/facebook账号用于登录各种类似的网站.</p>
<p><img src="https://www.wangbase.com/blogimg/asset/201904/bg2019042101.jpg" alt=""></p>
<h2 id="令牌和密码"><a href="#令牌和密码" class="headerlink" title="令牌和密码"></a>令牌和密码</h2><p><code>OAuth</code>的一个特点是使用Token.</p>
<p>令牌（token）与密码（password）的作用是一样的，都可以进入系统，但是有三点差异。</p>
<ol>
<li><p>令牌是短期的，到期会自动失效，用户自己无法修改。密码一般长期有效，用户不修改，就不会发生变化。</p>
</li>
<li><p>令牌可以被数据所有者撤销，会立即失效。以上例而言，屋主可以随时取消快递员的令牌。密码一般不允许被他人撤销。</p>
</li>
<li><p>令牌有权限范围（scope），比如只能进小区的二号门。对于网络服务来说，只读令牌就比读写令牌更安全。密码一般是完整权限。</p>
</li>
</ol>
<p>上面这些设计，保证了令牌既可以让第三方应用获得权限，同时又随时可控，不会危及系统安全。这就是 OAuth 2.0 的优点。</p>
<p>注意，只要知道了令牌，就能进入系统。系统一般不会再次确认身份，所以<strong>令牌必须保密，泄漏令牌与泄漏密码的后果是一样的。</strong>这也是为什么令牌的有效期，一般都设置得很短的原因。</p>
<h2 id="四种授权方式"><a href="#四种授权方式" class="headerlink" title="四种授权方式"></a>四种授权方式</h2><p>具体描述详见<a href="http://www.ruanyifeng.com/blog/2019/04/oauth-grant-types.html">文章</a>, 具体的认证流程的就不摘录了, 只摘录特点</p>
<h3 id="授权码"><a href="#授权码" class="headerlink" title="授权码"></a>授权码</h3><p>这种方式是最常用的流程，安全性也最高，它<strong>适用于那些有后端的 Web 应用</strong>。授权码通过前端传送，令牌则是储存在后端，而且所有与资源服务器的通信都在后端完成。这样的前后端分离，可以避免令牌泄漏。</p>
<h3 id="隐藏式"><a href="#隐藏式" class="headerlink" title="隐藏式"></a>隐藏式</h3><p>有些 Web 应用是纯前端应用，没有后端。这时就不能用上面的方式了，必须将令牌储存在前端。<strong>RFC 6749 就规定了第二种方式，允许直接向前端颁发令牌。这种方式没有授权码这个中间步骤，所以称为（授权码）”隐藏式”（implicit）。</strong></p>
<p>这种方式把令牌直接传给前端，是很不安全的。因此，只能用于一些安全要求不高的场景，并且令牌的有效期必须非常短，通常就是会话期间（session）有效，浏览器关掉，令牌就失效了。</p>
<h3 id="密码式"><a href="#密码式" class="headerlink" title="密码式"></a>密码式</h3><p><strong>如果你高度信任某个应用，RFC 6749 也允许用户把用户名和密码，直接告诉该应用。该应用就使用你的密码，申请令牌，这种方式称为”密码式”（password）。</strong></p>
<p>这种方式需要用户给出自己的用户名/密码，显然风险很大，因此只适用于其他授权方式都无法采用的情况，而且必须是用户高度信任的应用。</p>
<h3 id="凭证式"><a href="#凭证式" class="headerlink" title="凭证式"></a>凭证式</h3><p><strong>最后一种方式是凭证式（client credentials），适用于没有前端的命令行应用，即在命令行下请求令牌。</strong></p>
<p>这种方式给出的令牌，是针对第三方应用的，而不是针对用户的，即有可能多个用户共享同一个令牌。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><strong>授权码</strong>是最常用的, 其他三个主要是为了针对特定的场景.</p>
<h2 id="代码案例"><a href="#代码案例" class="headerlink" title="代码案例"></a>代码案例</h2><p>参见这篇<a href="http://www.ruanyifeng.com/blog/2019/04/github-oauth.html">博客</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/17/SQLFlow%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Carlmartin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carlmartin' Blog">
      <meta itemprop="description" content="A place for codeing break.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Carlmartin' Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/17/SQLFlow%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">SQLFlow深度解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-17 14:09:33" itemprop="dateCreated datePublished" datetime="2019-08-17T14:09:33+08:00">2019-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-06 16:19:03" itemprop="dateModified" datetime="2024-03-06T16:19:03+08:00">2024-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="SQLFLow介绍"><a href="#SQLFLow介绍" class="headerlink" title="SQLFLow介绍"></a>SQLFLow介绍</h2><p>SQLFlow是阿里巴巴蚂蚁金服开源的一个AI On SQL的项目, 目标是<strong>SQL 引擎和 AI 引擎连接起来，让用户仅需几行 SQL 代码就能描述整个应用或者产品背后的数据流和 AI 构造</strong></p>
<p>SQLFlow 最早的初衷，就是希望解决分析师既要操作数据又要使用 AI、往往需要在两个甚至更多的系统之间切换、工作效率低的窘境。</p>
<p>目前业界已有的AI ON SQL的方案:</p>
<ul>
<li>Microsoft SQL Server：Microsoft SQL Server 支持机器学习服务，可以将 R 或 Python 编写的机器学习程序作为外部脚本运行.缺点: 需要编写R或者Python程序代码</li>
<li>Teradata SQL for DL：Teradata 也提供了 RESTful 服务，可以通过扩展的 SQL SELECT 语法调用. 缺点: 语法耦合了它的Rest服务 </li>
<li>Google BigQuery：Google BigQuery 通过引入 CREATE MODEL 语句让用 SQL 实现机器学习成为可能. 缺点: 支持的模型有点少, 深度学习还不支持.</li>
</ul>
<p>针对以上三个方案的缺点, SQLFlow的定义了自己的三个设计目标:</p>
<ul>
<li>这一解决方案应与许多 SQL 引擎都兼容，而不是只能兼容特定版本或类型的 SQL 引擎。</li>
<li>它应该支持复杂的机器学习模型，包括用于深度学习的 TensorFlow 和用于树模型的 XGBoost。</li>
<li>能够灵活地配置和运行前沿机器学习算法，包括指定特征交叉，无需在 SQL 语句中嵌入 Python 或 R 代码，以及完全集成超参数估计等。</li>
</ul>
<p>目前阶段来说, SQLFlow已经支持MySQL/MaxCompute/Hive, 机器学习框架已经支持TF和XGBoost.</p>
<p><strong>资源:</strong></p>
<p><a href="https://www.infoq.cn/article/vlVqC68h2MT-028lh68C">宣传文章</a></p>
<p><a href="https://github.com/sql-machine-learning/sqlflow">Github官网</a></p>
<p><a href="https://sqlflow.org">官方文档</a></p>
<blockquote>
<p>Spark社区既有MLib这样的机器学习框架, 也有一些基于深度学习的扩展, 例如<a href="https://github.com/horovod/horovod">Uber的horovod</a>还有<a href="https://github.com/yahoo/TensorFlowOnSpark">Yahoo的TensorFlowOnSpark</a>, 但是这些框架都是基于的是Spark DataSet的接口联通的, 你可以在DataSet API上使用SQL, 也可以使用AI接口,  你可以认为是<code>AI + SQL</code>的模式, 而不是<code>AI ON SQL</code>的模式</p>
</blockquote>
<h2 id="SQLFlow试用"><a href="#SQLFlow试用" class="headerlink" title="SQLFlow试用"></a>SQLFlow试用</h2><p>社区提供了一个官方的试用的Docker镜像, 只要键入以下命令启动容器即可:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8888:8888 sqlflow/sqlflow:latest</span><br></pre></td></tr></table></figure>
<p>试用浏览器打开容器机器所在的8888端口, 可以看到一个notebook的页面, 默认已经有一个<code>example.ipynb</code>的样例文件了</p>
<p><img src="https://carlmartin-pic-1305764798.cos.ap-chengdu.myqcloud.com/hexo/images/sqlflow/2.png" alt=""></p>
<p>打开这个<code>example.ipynb</code>文件, 这个镜像里面已经安装了<code>mysql</code>, 同时也把部分测试数据导入到数据库里面, 你不需要做任何数据处理的工作, 就可以直接运行Notebook里面的Cell. <em>蚂蚁的开发人员真的很贴心啊</em></p>
<p><img src="https://carlmartin-pic-1305764798.cos.ap-chengdu.myqcloud.com/hexo/images/sqlflow/3.png" alt=""></p>
<p>执行推理过程, 使用<code>DNNClassifier</code>算法模型, 并将结果写入到<code>sqlflow_models.my_dnn_model</code>表中, <code>my_dnn_model</code>只有两个字段: ID和BLOB(存放模型序列化后的字节流)</p>
<p>执行对于测试集(<code>iris.test</code>)进行推理, 并写入到预测结果表之中(<code>iris.predict.class</code>)</p>
<p>最后展示推理结果集<code>iris.predict</code></p>
<p><img src="https://carlmartin-pic-1305764798.cos.ap-chengdu.myqcloud.com/hexo/images/sqlflow/4.png" alt=""></p>
<h2 id="架构解析"><a href="#架构解析" class="headerlink" title="架构解析"></a>架构解析</h2><p>这个AI ON SQL系统里面, 首先要回到的一个问题是, <strong>AI系统的计算层和SQL系统的计算层是什么关系?</strong></p>
<p>例如Spark(BigQuery大概率也是, 但是因为闭源不能确定)AI引擎代码是内嵌于SQL计算系统之中的, 并行执行的能力由Spark管理, AI系统就像代码库一样被Spark系统所调用而已.</p>
<p>但SQLFlow明显不是这种模式的:</p>
<p><img src="https://carlmartin-pic-1305764798.cos.ap-chengdu.myqcloud.com/hexo/images/sqlflow/1.png" alt=""></p>
<p>从SQLFlow的架构图上看的出来, <strong>AI Engine和SQL Engine之间是独立的</strong>, 两者通过RPC交互<strong>数据和模型</strong></p>
<ol>
<li>AI Engine训练或者推理计算的时候, 从SQLEngine获取数据</li>
<li>AI Engine完成训练过程, 将模型写入到SQL Engine; 推理过程从SQL Engine读取模型</li>
</ol>
<p>整个SQLFlow的流程大致如下(图上红色部分为SQLFlow):</p>
<ol>
<li>Notebook输入SQL之后, 送入到<code>Parser</code>之内, 这儿的语法解析借用了Hive/MaxCompute等引擎</li>
<li>解析完SQL语法后, 进行<code>Schema Verification</code></li>
<li>然后根据SQL语法, 产生对应的Code(根据不同模型和不同引擎产生不同的Code)</li>
<li>最后执行Code</li>
</ol>
<p><a href="https://sql-machine-learning.github.io/sqlflow/doc/syntax.html">设计文档</a></p>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><p>最后我们来简单过一遍SQLFlow的代码, 提炼一下找代码框架的思路:</p>
<blockquote>
<p>SQLFlow代码量目测在1-1.5万行左右, 半天就能看懂基础流程了</p>
</blockquote>
<h3 id="找到入口"><a href="#找到入口" class="headerlink" title="找到入口"></a>找到入口</h3><p>首先, 找到整个项目的Dockerfile, 就在根目录下</p>
<blockquote>
<p>如果项目有Docker镜像, Dockerfile就是个个进程的入口, 比<code>main</code>函数还在前面</p>
</blockquote>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span><span class="language-bash"> scripts/start.sh /</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;/start.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>看到最后一行启动的命令为<code>start.sh</code>, 源码文件在<code>scripts/start.sh</code></p>
<h3 id="找到启动文件"><a href="#找到启动文件" class="headerlink" title="找到启动文件"></a>找到启动文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">print_usage</span></span>() &#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Usage: /bin/bash start.sh [OPTION]\n&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;\tpopulate-example-dataset-mysql: populate an existing mysql instance with the example dataset.&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;\tmysql: setup the mysql server with the example dataset initialized.&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;\tsqlflow_server: setup the sqlflow gRPC server.&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;\tsqlflow_notebook: setup the Jupyter Notebook server.&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;\tall(default): setup a MySQL server instance, a sqlflow gRPC server and a Jupyter Notebook server sequentially.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">  ARG=<span class="variable">$&#123;1:-all&#125;</span></span><br><span class="line">  <span class="keyword">case</span> <span class="variable">$ARG</span> <span class="keyword">in</span></span><br><span class="line">    all)</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;setup all-in-one&quot;</span></span><br><span class="line">      setup_mysql</span><br><span class="line">      setup_sqlflow_server &amp;</span><br><span class="line">      setup_sqlflow_notebook</span><br><span class="line">      ;;</span><br><span class="line">    *)</span><br><span class="line">      print_usage</span><br><span class="line">      ;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到启动文件启动了三个内容: </p>
<ol>
<li><p>mysql: 默认的SQL Engine, 已经初始化了数据</p>
</li>
<li><p>sqlflow_server: 我们要找的程序, 找到里面真正的执行命令<code>sqlflowserver --datasource=$&#123;DS&#125;</code></p>
</li>
<li><p>sqlflow_notebook: Notebook交互式界面</p>
</li>
</ol>
<h3 id="找到main函数入口"><a href="#找到main函数入口" class="headerlink" title="找到main函数入口"></a>找到main函数入口</h3><p>全局搜索<code>function main()</code>, 发现只有<code>cmd/sqlflowserver/main.go</code>有.</p>
<p>在<code>start</code>函数里面找到关键的<code>proto.RegisterSQLFlowServer(s, server.NewServer(sql.Run, nil, modelDir, enableSession))</code>服务启动代码, 其中的<code>sql.Run</code>就整个SQL处理代码.</p>
<blockquote>
<p>不太熟悉go语言是怎么出包的</p>
</blockquote>
<h3 id="SQL-Run"><a href="#SQL-Run" class="headerlink" title="SQL.Run"></a>SQL.Run</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Run</span><span class="params">(slct <span class="type">string</span>, db *DB, modelDir <span class="type">string</span>, session *pb.Session)</span></span> *PipeReader &#123;</span><br><span class="line">	splittedSQL, err := splitExtendedSQL(slct)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		rd, wr := Pipe()</span><br><span class="line">		<span class="comment">// return the lexer error message to client side</span></span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> wr.Close()</span><br><span class="line">			wr.Write(err)</span><br><span class="line">		&#125;()</span><br><span class="line">		<span class="keyword">return</span> rd</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(splittedSQL) == <span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> runExtendedSQL(slct, db, modelDir, session)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> runStandardSQL(slct, db)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是SQL语句, 走入到<code>runStandardSQL</code>分支, 如果有训练或者推理语法, 就会走入<code>runExtendedSQL</code>分支</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runExtendedSQL</span><span class="params">(slct <span class="type">string</span>, db *DB, modelDir <span class="type">string</span>, session *pb.Session)</span></span> *PipeReader &#123;</span><br><span class="line">	rd, wr := Pipe()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> wr.Close()</span><br><span class="line"></span><br><span class="line">		err := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(startAt time.Time)</span></span> &#123;</span><br><span class="line">				log.Debugf(<span class="string">&quot;runExtendedSQL %v finished, elapsed:%v&quot;</span>, slct, time.Since(startAt))</span><br><span class="line">			&#125;(time.Now())</span><br><span class="line">			pr, e := newParser().Parse(slct) <span class="comment">// 语言解析</span></span><br><span class="line">			<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> e</span><br><span class="line">			&#125;</span><br><span class="line">			cwd, e := ioutil.TempDir(<span class="string">&quot;/tmp&quot;</span>, <span class="string">&quot;sqlflow&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> e</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">defer</span> os.RemoveAll(cwd)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> pr.train &#123;</span><br><span class="line">				ds, e := newTrainAndValDataset(db, pr.standardSelect.String(), pr.standardSelect.tables[<span class="number">0</span>], <span class="number">0.8</span>)</span><br><span class="line">				<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> e</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">return</span> train(wr, pr, db, cwd, modelDir, slct, ds) <span class="comment">// 调用训练</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> pred(wr, pr, db, cwd, modelDir) <span class="comment">// 调用推理部分</span></span><br><span class="line">		&#125;()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Errorf(<span class="string">&quot;runExtendedSQL error:%v&quot;</span>, err)</span><br><span class="line">			<span class="keyword">if</span> err != ErrClosedPipe &#123;</span><br><span class="line">				<span class="keyword">if</span> err := wr.Write(err); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					log.Errorf(<span class="string">&quot;runExtendedSQL error(piping):%v&quot;</span>, err)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">return</span> rd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到, 先进行<strong>语法解析</strong>, 然后进行<strong>训练或者推理</strong>逻辑, 我们简单看一眼<strong>训练</strong>过程:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">train</span><span class="params">(wr *PipeWriter, tr *extendedSelect, db *DB, cwd <span class="type">string</span>, modelDir <span class="type">string</span>, slct <span class="type">string</span>, ds *trainAndValDataset)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	fts, e := verify(tr, db) <span class="comment">// 语法校验</span></span><br><span class="line">	<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> e</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> program bytes.Buffer</span><br><span class="line">	<span class="keyword">if</span> e := genTF(&amp;program, tr, ds, fts, db); e != <span class="literal">nil</span> &#123; <span class="comment">// 生成代码</span></span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;genTF %v&quot;</span>, e)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cw := &amp;logChanWriter&#123;wr: wr&#125;</span><br><span class="line">	<span class="keyword">defer</span> cw.Close()</span><br><span class="line">	cmd := tensorflowCmd(cwd, db.driverName) <span class="comment">// 执行命令</span></span><br><span class="line">	cmd.Stdin = &amp;program</span><br><span class="line">	cmd.Stdout = cw</span><br><span class="line">	cmd.Stderr = cw</span><br><span class="line">	<span class="keyword">if</span> e := cmd.Run(); e != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;training failed %v&quot;</span>, e)</span><br><span class="line">	&#125;</span><br><span class="line">	m := model&#123;workDir: cwd, TrainSelect: slct&#125;</span><br><span class="line">	<span class="keyword">if</span> modelDir != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> m.saveTar(modelDir, tr.save) <span class="comment">// 保存模型到本地文件夹</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> m.save(db, tr.save) <span class="comment">// 保存模型到数据库</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到, 进入训练过程之后, 先做了<strong>语法校验</strong>, 然后<strong>生成的对应的TF的代码</strong>, 然后调用<code>tensorflowCmd</code><strong>执行命令</strong>, 最后将<strong>模型保存</strong>完毕, 完成训练过程.</p>
<p><strong>语法校验</strong>先略过, <strong>代码生成</strong>过程比较复杂后面再介绍, 我们先关注于<strong>命令执行</strong>过程:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tensorflowCmd</span><span class="params">(cwd, driverName <span class="type">string</span>)</span></span> (cmd *exec.Cmd) &#123;</span><br><span class="line">	<span class="keyword">if</span> hasPython() &amp;&amp; hasTensorFlow() &amp;&amp; hasDatabaseConnector(driverName) &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;tensorflowCmd: run locally&quot;</span>)</span><br><span class="line">		cmd = exec.Command(<span class="string">&quot;python&quot;</span>, <span class="string">&quot;-u&quot;</span>)</span><br><span class="line">		cmd.Dir = cwd</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> hasDocker() &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;tensorflowCmd: run in Docker container&quot;</span>)</span><br><span class="line">		<span class="keyword">const</span> tfImg = <span class="string">&quot;sqlflow/sqlflow&quot;</span></span><br><span class="line">		<span class="keyword">if</span> !hasDockerImage(tfImg) &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;No local Docker image %s.  It will take a long time to pull.&quot;</span>, tfImg)</span><br><span class="line">		&#125;</span><br><span class="line">		cmd = exec.Command(<span class="string">&quot;docker&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;--rm&quot;</span>,</span><br><span class="line">			fmt.Sprintf(<span class="string">&quot;-v%s:/work&quot;</span>, cwd),</span><br><span class="line">			<span class="string">&quot;-w/work&quot;</span>, <span class="string">&quot;--network=host&quot;</span>, <span class="string">&quot;-i&quot;</span>, tfImg, <span class="string">&quot;python&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;No local TensorFlow or Docker.  No way to run TensorFlow programs&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> cmd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>tensorflowCmd</code>有两种执行模式: <strong>本地执行</strong>和<strong>容器执行</strong>, 目前这两种方式都是单机执行模型, 实际上这儿就印证了<strong>AI Engine和SQL Engine分离</strong>的架构</p>
<p>未来这儿可以很方便的将这个扩展为分布式任务, 例如Kubeflow的TFJob,这个这块需要跟代码生成那儿一起修改.</p>
<h3 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h3><p>让我们在回到<code>genTF</code>这个函数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">genTF</span><span class="params">(w io.Writer, pr *extendedSelect, ds *trainAndValDataset, fts fieldTypes, db *DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	r, e := newFiller(pr, ds, fts, db) <span class="comment">// 应该是按照字段的过滤吧, 没仔细看, 可能会出错</span></span><br><span class="line">	<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> e</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> pr.train &#123;</span><br><span class="line">		<span class="keyword">return</span> tfTrainTemplate.Execute(w, r) <span class="comment">// 根据训练模板生成code</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> tfPredTemplate.Execute(w, r) <span class="comment">// 根据推理模板生成code</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tfTrainTemplate = template.Must(template.New(<span class="string">&quot;codegenTfTrain&quot;</span>).Parse(tfTrainTemplateText)) <span class="comment">// 训练模板</span></span><br><span class="line"><span class="keyword">var</span> tfPredTemplate = template.Must(template.New(<span class="string">&quot;codegenTfPred&quot;</span>).Parse(tfPredTemplateText)) <span class="comment">// 推理模板</span></span><br></pre></td></tr></table></figure>
<p>这儿实际上最关键的是两个训练模板, 这两个模块在<code>template_tf.go</code>里面定义</p>
<blockquote>
<p>除了TF的模板, 还有<code>template_alps</code>和<code>template_elasticdl</code>这两个</p>
</blockquote>
<p>模板里面就是Python代码了, 截取里面的一部分说明一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># Disable Tensorflow INFO and WARNING logs</span></span><br><span class="line">os.environ[<span class="string">&#x27;TF_CPP_MIN_LOG_LEVEL&#x27;</span>] = <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys, json</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="keyword">import</span> sqlflow_models <span class="comment"># 注意点1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlflow_submitter.db <span class="keyword">import</span> connect, db_generator <span class="comment"># 注意点2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 忽略一部分代码</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">input_fn</span>(<span class="params">datasetStr</span>):</span><br><span class="line">    feature_types = []</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> feature_column_names:</span><br><span class="line">        <span class="keyword">if</span> feature_metas[name][<span class="string">&quot;is_sparse&quot;</span>]:</span><br><span class="line">            feature_types.append((tf.int64, tf.int32, tf.int64))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            feature_types.append(get_dtype(feature_metas[name][<span class="string">&quot;dtype&quot;</span>]))</span><br><span class="line"></span><br><span class="line">    gen = db_generator(driver, conn, datasetStr, feature_column_names, <span class="string">&quot;&#123;&#123;.Y.FeatureName&#125;&#125;&quot;</span>, feature_metas)</span><br><span class="line">    dataset = tf.data.Dataset.from_generator(gen, (<span class="built_in">tuple</span>(feature_types), tf.&#123;&#123;.Y.Dtype&#125;&#125;)) <span class="comment"># 注意点3</span></span><br><span class="line">    ds_mapper = functools.partial(_parse_sparse_feature, feature_metas=feature_metas)</span><br><span class="line">    <span class="keyword">return</span> dataset.<span class="built_in">map</span>(ds_mapper)</span><br></pre></td></tr></table></figure>
<p><strong>注意点1</strong>是<code>sqlflow_models</code>, 这个是定义在同组织的<a href="https://github.com/sql-machine-learning/models">Model</a>里面,  目前只实现了2个实现<code>dnnclassifier</code>和<code>lstmclassifier</code>, 这里这个<code>dnnclassifier</code>就是试用里面<code>DNNClassifier</code>算法模型的定义所在</p>
<p><img src="https://carlmartin-pic-1305764798.cos.ap-chengdu.myqcloud.com/hexo/images/sqlflow/5.png" alt=""></p>
<p><strong>注意点2</strong>是<code>sqlflow_submitter</code>这个定义在<code>sql/python/sqlflow_submmiter</code>包目录下, 在这儿你可以执行本地的Python文件, 也可以定义自己的submit将<code>CodeGen</code>的代码当做客户端代码, 给远程的深度学习服务提交自己的学习任务. 同时这儿也定义了与<code>SQL Engine</code>的交互代码逻辑, 就是里面的<code>connect</code>和<code>db_generator</code></p>
<p><strong>注意点3</strong>关注于TensorFlow框架是如何读取从数据库里面的数据的, 使用的接口为<code>tf.data.Dataset.from_generator</code></p>
<p><strong>至此代码分析已经完成, 主流程已经明确了.</strong></p>
<h2 id="社区动态"><a href="#社区动态" class="headerlink" title="社区动态"></a>社区动态</h2><p>蚂蚁对于这个项目的投入还是很大的, 应该由专门的人在投入这个项目, 更新频率还是相当快的</p>
<p><img src="https://carlmartin-pic-1305764798.cos.ap-chengdu.myqcloud.com/hexo/images/sqlflow/6.png" alt=""></p>
<p>但是贡献者还是比较少的, 应该目前看只有21贡献者, 基本上是蚂蚁金服内部员工.</p>
<p>之前看到他们2019年的<a href="https://github.com/sql-machine-learning/sqlflow/issues/327">路标</a>, 2019年的目标预定是支持各种框架, 例如<strong>Calcite支持</strong>或者<strong>GPU TF支持</strong></p>
<p>总体来说2019年主要在完善功能, 但是后来这个ISSUE关闭了, 不确定19年能否完成这些内容.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>SQLFlow目前看还处于原型阶段, 整体支持的能力还非常欠缺: GPU的支持, 模型的定义等功能目前好像都不具备.</p>
<p>就目前整体的设计, 我认为以下三点未来需要加强:</p>
<ol>
<li>模型定义接口太复杂了: 1. 实现一个模板;2. 实现一个模型算法;3. 实现一个submitter. 这套逻辑对于工程师可能比较简单(实际上定义地方太多, 也麻烦), 但是对于AI算法的人, 肯定不是用</li>
<li><code>AI Engine</code>和<code>SQL Engine</code>分离带来的性能问题, 这套架构的问题就是AI系统离数据远了一点, 所有数据都是通过<code>SQL Engine</code>计算而来, 而且是通过RPC获取的数据, 比起Spark这种直接在内存中获取数据, 这里会成为正式商用时候的大瓶颈点</li>
<li>数据分布式化工程量太大, 这其实是问题二的引申版, 未来肯定要实现数据分布化, AI计算分布式化, 这钟模式我还没有想到如何分布式化(<em>回去再好好想想</em>)</li>
</ol>
<p>另外对于这个项目的商业前景如何, 这个确实存疑的, 也许在阿里内部可能有这部分需求, 但对我们来说却不是.</p>
<p>2018年8月BigQuery出了ML之后, 我们也有计划跟进, 调研了<a href="https://xgboost.readthedocs.io/en/latest/jvm/xgboost4j_spark_tutorial.html">XGBoost On Spark</a>, 但最后还是没决定要做, 最主要的原因是没有客户明确需要这个能力.</p>
<blockquote>
<p> 值得表扬的是: 蚂蚁的文档和demo做的是真好, 做技术调研能遇到这样的项目, 确实让我省了不少功夫. </p>
</blockquote>
<h2 id="附录-Go语言环境安装"><a href="#附录-Go语言环境安装" class="headerlink" title="附录: Go语言环境安装"></a>附录: Go语言环境安装</h2><blockquote>
<p>SQLFlow的主编程语言为Go语言, 安装部署也相对方便, 不记录过程了, 只放置一些安装资源链接</p>
</blockquote>
<p><a href="https://dl.google.com/go/go1.12.9.windows-amd64.msi">Go安装包</a></p>
<p><a href="https://www.jetbrains.com/go/download/#section=windows">GoLand下载地址</a></p>
<p><a href="http://idea.lanyus.com/">GoLand破解</a></p>
<p><a href="http://blog.lanyus.com/archives/174.html">IDEA License Server搭建</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/11/Kubeflow%E7%B3%BB%E5%88%97-%E7%95%AA%E5%A4%96-TensorServing%E4%BE%8B%E5%AD%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Carlmartin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carlmartin' Blog">
      <meta itemprop="description" content="A place for codeing break.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Carlmartin' Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/11/Kubeflow%E7%B3%BB%E5%88%97-%E7%95%AA%E5%A4%96-TensorServing%E4%BE%8B%E5%AD%90/" class="post-title-link" itemprop="url">[Kubeflow系列]番外:TensorServing例子</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-11 17:14:03" itemprop="dateCreated datePublished" datetime="2019-08-11T17:14:03+08:00">2019-08-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-06 16:19:03" itemprop="dateModified" datetime="2024-03-06T16:19:03+08:00">2024-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h2><p>最近做产品的时候, 由算法团队写完AI算法模型, 由我们产品团队完成对工程化的改造, 然后再把API上线.</p>
<p>但是这个时候遇到沟通成本很高, AI算法大多是探索式的,  输入是比较少边的, 但是输出可能会多次变化, 这样对产品化人员又很麻烦, 本来就是很简单的代码, 就是需要不停的修改, 用来适配整体的API.</p>
<blockquote>
<p>这里有个前提: 尽量让算法的人员减少对产品的代码的感知, 毕竟他们不是专业的</p>
</blockquote>
<p>因此, 我查了一下开源社区对这个问题的处理方式, 最后还真查到了<code>TF Serving</code>这个工程, 决定调研一下是否能够解决我的问题.</p>
<p><code>TF Serving</code>是<a href="https://www.tensorflow.org/tfx">TensorFlow Extended</a>工程的一个子工程, <code>TFX</code>是一个端到端的AI平台, 简单理解就是:</p>
<p><strong>他的关注点在于AI机器学习的工程化部分</strong></p>
<p><code>TFX</code>总共有4个模块:</p>
<ol>
<li>TensorFlow Data Validation: <em>TensorFlow Data Validation (TFDV) 能够帮助开发者大规模地理解、验证和监控机器学习数据。Google 每天都使用 TFDV 分析和验证 PB 级的数据，并且在帮助 TFX 用户维护机器学习流水线正常运行方面，TFDV 一贯表现良好</em></li>
<li>TensorFlow Transform: <em>在将机器学习应用于现实世界的数据集时，需要投入很多精力才能将数据预处理为合适的格式，其中包括在各种格式之间进行转换、对文本进行标记化和词干化、创建词汇表、执行归一化等各种数字操作。您可以使用 tf.Transform 完成所有这些操作</em></li>
<li>TensorFlow Model Analysis: <em>TensorFlow Model Analysis (TFMA) 让开发者能够计算和可视化模型的评估指标。在部署任何机器学习 (ML) 模型之前，机器学习开发者需要评估模型的性能，以确保其达到特定的质量阈值，并且能够针对所有相关数据切片展示出与预期相符的行为。例如，模型针对整个评估数据集的 AUC 可能是可接受的，但针对特定切片却表现不佳。TFMA 为开发者提供了深入了解其模型性能的工具</em></li>
<li>TensorFlow Serving: <em>机器学习 (ML) 应用系统必须支持模型版本控制（用于实现包含回滚选项的模型更新）和多个模型（用于实现通过 A/B 测试进行的实验），同时还要确保并发模型能够在硬件加速器（GPU 和 TPU）上以较低的延迟实现较高的吞吐量。TensorFlow Serving 每秒能为 Google 处理数千万次推断</em></li>
</ol>
<p>这4个模块都是很有用的点, 但这次我的重点在<code>TensorFlow Serving</code></p>
<h2 id="TensorFlow-Serving"><a href="#TensorFlow-Serving" class="headerlink" title="TensorFlow Serving"></a>TensorFlow Serving</h2><p>在网上的教程之中, 就一个<strong>提供模型</strong>的<a href="https://www.tensorflow.org/tfx/tutorials/serving/rest_simple">章节</a>详细介绍了<code>TF Serving</code>的一个例子</p>
<p>按照Notebook的教程运行一下这个例子(不需要使用GPU, 使用CPU的速度就可以了), 我们简单的分解一下这个过程</p>
<blockquote>
<p>直接在本地安装一个Notebook就可以运行, 除了安装<code>tensorflow-model-server</code>可能需要翻墙, 需要手动设置一起, 其他的可以直接运行出来</p>
</blockquote>
<p>训练过程:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义模型</span></span><br><span class="line">model = keras.Sequential([</span><br><span class="line">  keras.layers.Conv2D(input_shape=(<span class="number">28</span>,<span class="number">28</span>,<span class="number">1</span>), filters=<span class="number">8</span>, kernel_size=<span class="number">3</span>, </span><br><span class="line">                      strides=<span class="number">2</span>, activation=<span class="string">&#x27;relu&#x27;</span>, name=<span class="string">&#x27;Conv1&#x27;</span>),</span><br><span class="line">  keras.layers.Flatten(),</span><br><span class="line">  keras.layers.Dense(<span class="number">10</span>, activation=tf.nn.softmax, name=<span class="string">&#x27;Softmax&#x27;</span>)</span><br><span class="line">])</span><br><span class="line">model.summary()</span><br><span class="line"></span><br><span class="line">testing = <span class="literal">False</span></span><br><span class="line">epochs = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=tf.train.AdamOptimizer(), </span><br><span class="line">              loss=<span class="string">&#x27;sparse_categorical_crossentropy&#x27;</span>,</span><br><span class="line">              metrics=[<span class="string">&#x27;accuracy&#x27;</span>])</span><br><span class="line"><span class="comment"># 开始训练</span></span><br><span class="line">model.fit(train_images, train_labels, epochs=epochs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用测试集推理</span></span><br><span class="line">test_loss, test_acc = model.evaluate(test_images, test_labels)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;\nTest accuracy: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(test_acc))</span><br></pre></td></tr></table></figure>
<p>实际上在<code>模型定义</code>的步骤之中, 模型的输入输出实际上已经定了,  但是这里的<strong>输入应该只能是tensor类型的</strong></p>
<p>使用工具, 查看查看模型输入输出:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!saved_model_cli show --<span class="built_in">dir</span> &#123;export_path&#125; --all</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">MetaGraphDef with tag-set: &#x27;serve&#x27; contains the following SignatureDefs:</span><br><span class="line"></span><br><span class="line">signature_def[&#x27;serving_default&#x27;]:</span><br><span class="line">  The given SavedModel SignatureDef contains the following input(s):</span><br><span class="line">    inputs[&#x27;input_image&#x27;] tensor_info:</span><br><span class="line">        dtype: DT_FLOAT</span><br><span class="line">        shape: (-1, 28, 28, 1)</span><br><span class="line">        name: Conv1_input:0</span><br><span class="line">  The given SavedModel SignatureDef contains the following output(s):</span><br><span class="line">    outputs[&#x27;Softmax/Softmax:0&#x27;] tensor_info:</span><br><span class="line">        dtype: DT_FLOAT</span><br><span class="line">        shape: (-1, 10)</span><br><span class="line">        name: Softmax/Softmax:0</span><br><span class="line">  Method name is: tensorflow/serving/predict</span><br></pre></td></tr></table></figure>
<p>创建Serving时候, 参数只要指定模型的路径即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> tensorflow_model_server \</span><br><span class="line">  --rest_api_port=8501 \</span><br><span class="line">  --model_name=fashion_model \</span><br><span class="line">  --model_base_path=<span class="string">&quot;<span class="variable">$&#123;MODEL_DIR&#125;</span>&quot;</span> &gt;server.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>使用客户端, 给<code>8501</code>端口发送请求, 地址为<code>http://localhost:8501/v1/models/fashion_model:predict</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">headers = &#123;<span class="string">&quot;content-type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;</span><br><span class="line">json_response = requests.post(<span class="string">&#x27;http://localhost:8501/v1/models/fashion_model:predict&#x27;</span>, data=data, headers=headers)</span><br><span class="line">predictions = json.loads(json_response.text)[<span class="string">&#x27;predictions&#x27;</span>]</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>, <span class="string">&#x27;The model thought this was a &#123;&#125; (class &#123;&#125;), and it was actually a &#123;&#125; (class &#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">  class_names[np.argmax(predictions[<span class="number">0</span>])], test_labels[<span class="number">0</span>], class_names[np.argmax(predictions[<span class="number">0</span>])], test_labels[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>
<p>除了HTTP请求, <code>TFServing</code>还支持<code>GRPC</code>协议, 端口默认开在<code>8500</code>端口</p>
<p>GRPC的例子可以看github上的<a href="https://github.com/tensorflow/serving/blob/master/tensorflow_serving/example/mnist_client.py">例子</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从这个例子上来看, <code>TF Serving</code>并不能完全解决上面的问题, 因为模型的输入输出的定义肯定是矩阵模式, 而实际产品之中的输入是非常多样化的, 可以是一个npp文件也可以是一张图片, 显然还需要一个预处理的步骤,才能达到Serving的步骤.</p>
<p>但<code>TF Serving</code>也是用的:</p>
<ol>
<li>不需要写模型推理代码了, 只要统一使用了TensorFlow框架, 推理就简单了</li>
<li>它有简单的模型版本控制, 用于不同版本之间的升级测试等问题(实际上就是一个简单的版本编号而已)</li>
</ol>
<p>那么回过头来, 如果想要解决产品和算法团队之间的GAP呢?</p>
<p>我想到的方式是, <strong>使用Kubeflow的Pipeline + TFServing</strong>:</p>
<ol>
<li>将常见的输入输出算法转化为component, 直接可以使用</li>
<li>允许算法人员自己定义component, 使用方式和本地变成类似</li>
<li>Pipeline能够可视化的将各个component连接在一起</li>
<li>模型推理使用<code>TFServing</code>发布</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/11/%E5%AE%89%E8%A3%85nvidia-docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Carlmartin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carlmartin' Blog">
      <meta itemprop="description" content="A place for codeing break.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Carlmartin' Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/11/%E5%AE%89%E8%A3%85nvidia-docker/" class="post-title-link" itemprop="url">安装nvidia-docker</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-11 16:26:46" itemprop="dateCreated datePublished" datetime="2019-08-11T16:26:46+08:00">2019-08-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-06 16:19:03" itemprop="dateModified" datetime="2024-03-06T16:19:03+08:00">2024-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>697</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>测试环境为: ubuntu == 18.04</p>
</blockquote>
<p>官方文档: <a href="https://github.com/nvidia/nvidia-docker/wiki/Installation-(version-2.0">https://github.com/nvidia/nvidia-docker/wiki/Installation-(version-2.0</a>)</p>
<blockquote>
<p>ubuntu18.04版本需要安装的是V2.0版本, 网上文章大多是V1.0的, 在这个版本的ubutnu无法安装</p>
</blockquote>
<p>安装命令: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加源</span></span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | \</span><br><span class="line">  sudo apt-key add -</span><br><span class="line">distribution=$(. /etc/os-release;<span class="built_in">echo</span> $ID<span class="variable">$VERSION_ID</span>)</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/<span class="variable">$distribution</span>/nvidia-docker.list | \</span><br><span class="line">  sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/nvidia-docker.list</span><br><span class="line">sudo apt-get update</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">sudo apt-get install nvidia-docker2</span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>
<p>启动镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-docker run -p 8888:8888   --dns 8.8.8.8 --dns 8.8.4.4 gcr.io/kubeflow-images-public/tensorflow-1.12.0-notebook-gpu:v0.5.0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>—dns 8.8.8.8 —dns 8.8.4.4指定公网DNS, 不然容器里面无法访问网络</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/11/Docker%E8%AE%BE%E7%BD%AE%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Carlmartin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carlmartin' Blog">
      <meta itemprop="description" content="A place for codeing break.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Carlmartin' Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/11/Docker%E8%AE%BE%E7%BD%AE%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%90%86/" class="post-title-link" itemprop="url">Docker设置配置代理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-11 14:46:55" itemprop="dateCreated datePublished" datetime="2019-08-11T14:46:55+08:00">2019-08-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-06 16:19:03" itemprop="dateModified" datetime="2024-03-06T16:19:03+08:00">2024-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>712</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>测试环境为: ubuntu == 18.04,  docker == 19.03.1</p>
</blockquote>
<p>有些docker容器是在Google Cloud上的是, 因此需要下载的时候, 需要配置代理才能访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 创建docker启动文件夹</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> -p /etc/systemd/system/docker.service.d</span><br><span class="line"><span class="comment">## 创建proxy配置文件</span></span><br><span class="line">sudo vim /etc/systemd/system/docker.service.d/http-proxy.conf</span><br></pre></td></tr></table></figure>
<p>写入以下配置项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;HTTP_PROXY=http://127.0.0.1:8118/&quot;</span> <span class="string">&quot;HTTPS_PROXY=http://127.0.0.1:8118/&quot;</span> <span class="string">&quot;NO_PROXY=localhost,127.0.0.1,registry.docker-cn.com,hub-mirror.c.163.com&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>http://127.0.0.1:8118</code>是shadowsocks转出来的http端口</p>
<p>不需要走代理的镜像仓库, 在<code>NO_PROXY</code>里配置</p>
</blockquote>
<p>配置生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 刷新配置项</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line"><span class="comment"># 重启docker服务</span></span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"><span class="comment"># 查看docker配置项</span></span><br><span class="line">sudo systemctl show --property=Environment docker</span><br></pre></td></tr></table></figure>
<p>测试是否生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull gcr.io/kubeflow-images-public/tensorflow-1.12.0-notebook-cpu:v0.5.0</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/03/%E7%BF%BB%E5%A2%99%E4%BB%A3%E7%90%86%E8%AE%BE%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Carlmartin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carlmartin' Blog">
      <meta itemprop="description" content="A place for codeing break.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Carlmartin' Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/03/%E7%BF%BB%E5%A2%99%E4%BB%A3%E7%90%86%E8%AE%BE%E7%BD%AE/" class="post-title-link" itemprop="url">翻墙代理设置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-03 22:45:48" itemprop="dateCreated datePublished" datetime="2019-08-03T22:45:48+08:00">2019-08-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-06 16:19:03" itemprop="dateModified" datetime="2024-03-06T16:19:03+08:00">2024-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近从同事手中借了一个<code>ShadowSocks</code>的账号, 用来翻墙使用, Windows和Mac使用的时候都比较简单, 因为有图形化的页面, 但是在Ubuntu上遇到不大不小的问题, 特意记录一下.</p>
<h2 id="安装客户端"><a href="#安装客户端" class="headerlink" title="安装客户端"></a>安装客户端</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果没有安装过pip, 请先安装</span></span><br><span class="line">sudo apt install python-pip</span><br><span class="line">sudo pip install shadowsocks</span><br><span class="line">sudo vim ~/shadowsocks.json</span><br></pre></td></tr></table></figure>
<p>填入你服务端的配置项:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span><span class="string">&quot;远端ip&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;server_port&quot;</span><span class="punctuation">:</span><span class="number">2443</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;local_port&quot;</span><span class="punctuation">:</span><span class="number">1080</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;密码&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;aes-256-cfb&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>启动客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sslocal -c ~/shadowsocks.json</span><br></pre></td></tr></table></figure>
<p>这个时候, 如果你的shadowsocks版本是2.8.2的话, 就会出现以下的异常信息:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">undefined symbol EVP_CIPHER_CTX_cleanup</span><br></pre></td></tr></table></figure>
<p>找到安装目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip list -v|grep shadowsocks</span><br><span class="line"><span class="comment"># shadowsocks       2.8.2             /home/wiiliam/miniconda3/lib/python3.6/site-packages                      pip </span></span><br><span class="line"><span class="built_in">cd</span> /home/wiiliam/miniconda3/lib/python3.6/site-packages/shadowsocks</span><br></pre></td></tr></table></figure>
<p>进入到安装后执行以下命令替换py的源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&quot;s/cleanup/reset/g&quot;</span>  crypto/openssl.py</span><br></pre></td></tr></table></figure>
<p>重新之后, 看到端口绑定日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">019-08-03 23:01:59 WARNING  warning: your <span class="built_in">timeout</span> 30 seems too short</span><br><span class="line">2019-08-03 23:01:59 INFO     loading libcrypto from libcrypto.so.1.1</span><br><span class="line">2019-08-03 23:01:59 INFO     starting <span class="built_in">local</span> at 127.0.0.1:1080</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意: 在linux上1080端口监听的类型是<code>socks5</code>, 而如果使用windows版本, 1080监听的是<code>http</code>类型. 这个时候使用<code>lsof -i:1080</code>是看不到socks5监听进程的.</p>
</blockquote>
<h2 id="Chrome代理设置"><a href="#Chrome代理设置" class="headerlink" title="Chrome代理设置"></a>Chrome代理设置</h2><p>Chrome有比较好的插件: <code>SwitchyOmega</code></p>
<p>在配置页面直接导入配置项:</p>
<p><img src="https://carlmartin-pic-1305764798.cos.ap-chengdu.myqcloud.com/hexo/images/shadowsocks/1.png" alt=""></p>
<p>然后修改<code>FWWed</code>的代理端口已经被正确设置</p>
<p><img src="https://carlmartin-pic-1305764798.cos.ap-chengdu.myqcloud.com/hexo/images/shadowsocks/2.png" alt=""></p>
<p>最后在Chrome的插件按钮上切换地址的时候, 使用<code>自动切换</code>即可</p>
<h2 id="Socks5代理转HTTP代理"><a href="#Socks5代理转HTTP代理" class="headerlink" title="Socks5代理转HTTP代理"></a>Socks5代理转HTTP代理</h2><p>国产的浏览器一般是不支持socks代理的, 所以需要讲sock5代理转为http代理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install privoxy</span><br><span class="line">sudo vi /etc/privoxy/config</span><br></pre></td></tr></table></figure>
<p>修改以下的配置项:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">isten-address localhost:8118</span><br><span class="line">forward-socks5t / 127.0.0.1:1080 .</span><br></pre></td></tr></table></figure>
<p>重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /etc/init.d/privoxy restart</span><br></pre></td></tr></table></figure>
<h2 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h2><blockquote>
<p>ubuntu18.04不再使用initd管理系统，改用systemd,为了像以前一样，在/etc/rc.local中设置开机启动程序，需要以下几步：systemd默认读取/etc/systemd/system下的配置文件，该目录下的文件会链接/lib/systemd/system/下的文件。一般系统安装完/lib/systemd/system/下会有rc-local.service文件，即我们需要的配置文件</p>
</blockquote>
<p>链接服务并修改服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -fs /lib/systemd/system/rc-local.service /etc/systemd/system/rc-local.service</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /etc/systemd/system/</span><br><span class="line">sudo vim rc-local.service</span><br></pre></td></tr></table></figure>
<p>加入部分设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  SPDX-License-Identifier: LGPL-2.1+</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This file is part of systemd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="comment">#  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># This unit gets pulled automatically into multi-user.target by</span></span><br><span class="line"><span class="comment"># systemd-rc-local-generator if /etc/rc.local is executable.</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=/etc/rc.local Compatibility</span><br><span class="line">Documentation=man:systemd-rc-local-generator(8)</span><br><span class="line">ConditionFileIsExecutable=/etc/rc.local</span><br><span class="line">After=network.target</span><br><span class="line"> </span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/etc/rc.local start</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RemainAfterExit=<span class="built_in">yes</span></span><br><span class="line">GuessMainPID=no</span><br><span class="line"> </span><br><span class="line"><span class="comment">## 这部分要新添加</span></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=rc-local.service</span><br></pre></td></tr></table></figure>
<p>创建<code>/etc/rc.local</code>文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/rc.local</span><br></pre></td></tr></table></figure>
<p>填入以下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh -e</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># rc.local</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This script is executed at the end of each multiuser runlevel.</span></span><br><span class="line"><span class="comment"># Make sure that the script will &quot;exit 0&quot; on success or any other</span></span><br><span class="line"><span class="comment"># value on error.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In order to enable or disable this script just change the execution</span></span><br><span class="line"><span class="comment"># bits.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># By default this script does nothing.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 填写脚本区域</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;test&quot;</span> &gt; /var/log/ss.log</span><br><span class="line">/home/wiiliam/miniconda3/bin/python /home/wiiliam/miniconda3/bin/sslocal -c /home/wiiliam/shadowsocks.json &gt; /home/wiiliam/shadowsocks.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment">### 脚本区域结束</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意这个脚本是以root用户启动的, 所以一定要确保root一定能访问相应的文件</p>
</blockquote>
<p>添加执行权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> 755 /etc/rc.local</span><br></pre></td></tr></table></figure>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://kionf.com/2016/12/15/errornote-ss/">SS客户端异常</a></p>
<p><a href="https://cao0507.github.io/2018/08/21/ubuntu%E9%85%8D%E7%BD%AEshadowsocks%E5%AE%A2%E6%88%B7%E7%AB%AF/">HTTP代理</a></p>
<p><a href="https://github.com/FelisCatus/SwitchyOmega/wiki/GFWList">Chrome设置SwitchyOmega</a></p>
<p><a href="https://blog.csdn.net/zhengchaooo/article/details/80202599">开机启动设置</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/01/Kubernetes%E7%9F%A5%E8%AF%86%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Carlmartin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carlmartin' Blog">
      <meta itemprop="description" content="A place for codeing break.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Carlmartin' Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/01/Kubernetes%E7%9F%A5%E8%AF%86%E7%82%B9/" class="post-title-link" itemprop="url">Kubernetes知识点</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-01 18:38:58" itemprop="dateCreated datePublished" datetime="2019-08-01T18:38:58+08:00">2019-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-06 16:19:03" itemprop="dateModified" datetime="2024-03-06T16:19:03+08:00">2024-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="污点和容忍"><a href="#污点和容忍" class="headerlink" title="污点和容忍"></a>污点和容忍</h2><p>如果你不想在某个节点上, 执行任何Pod, 你可以通过Kubernetes的<strong>Taints</strong>特性实现</p>
<p>每个污点的组成如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key=value:effect</span><br></pre></td></tr></table></figure>
<p>每个污点有一个key和value作为污点的标签，其中value可以为空，effect描述污点的作用。当前taint effect支持如下三个选项：</p>
<ul>
<li><code>NoSchedule</code>：表示k8s将不会将Pod调度到具有该污点的Node上</li>
<li><code>PreferNoSchedule</code>：表示k8s将尽量避免将Pod调度到具有该污点的Node上</li>
<li><code>NoExecute</code>：表示k8s将不会将Pod调度到具有该污点的Node上，同时会将Node上已经存在的Pod驱逐出去</li>
</ul>
<p><strong>污点的设置和去除</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置污点</span></span><br><span class="line">kubectl taint nodes node1 key1=value1:NoSchedule</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去除污点</span></span><br><span class="line">kubectl taint nodes node1 key1:NoSchedule-</span><br></pre></td></tr></table></figure>
<p><strong>容忍</strong></p>
<p>设置了污点的Node将根据taint的effect：NoSchedule、PreferNoSchedule、NoExecute和Pod之间产生互斥的关系，Pod将在一定程度上不会被调度到Node上。 但我们可以在Pod上设置容忍(Toleration)，意思是设置了容忍的Pod将可以容忍污点的存在，可以被调度到存在污点的Node上。</p>
<p>通过在Pod的spec中设置tolerations字段，给Pod设置上容忍点Toleration：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key1&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;value1&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">  <span class="attr">tolerationSeconds:</span> <span class="number">3600</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key1&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;value1&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key2&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>参考</strong></p>
<p><a href="https://blog.frognew.com/2018/05/taint-and-toleration.html">博客</a></p>
<h2 id="Kubernetes的调度器"><a href="#Kubernetes的调度器" class="headerlink" title="Kubernetes的调度器"></a>Kubernetes的调度器</h2><p>Kubernetes的默认调度器叫做<code>kube-scheduler</code>, 但是你可以自己实现一个调度器, 例如<a href="https://github.com/volcano-sh/volcano">volcano</a></p>
<p>创建Pod的时候可以指定<code>spec.schedulerName</code>为自己的调度器</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">annotation-second-scheduler</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">multischeduler-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedulerName:</span> <span class="string">my-scheduler</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-with-second-annotation-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/pause:2.0</span></span><br></pre></td></tr></table></figure>
<p><strong>参考</strong></p>
<p><a href="https://k8smeetup.github.io/docs/tasks/administer-cluster/configure-multiple-schedulers/">配置多个调度器</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/47047550">如何实现一个调度器</a></p>
<h2 id="Kubernetes-Operator入门"><a href="#Kubernetes-Operator入门" class="headerlink" title="Kubernetes Operator入门"></a>Kubernetes Operator入门</h2><p><a href="https://www.qikqiak.com/post/k8s-operator-101/">参考</a></p>
<h2 id="强制删除资源"><a href="#强制删除资源" class="headerlink" title="强制删除资源"></a>强制删除资源</h2><p>问题：kubelet delete pod之后总处于Terminating，无法移除</p>
<p>解决：加参数 —force —grace-period=0，grace-period表示过渡存活期，默认30s，在删除POD之前允许POD慢慢终止其上的容器进程，从而优雅退出，0表示立即终止POD</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete po -n --force --grace-period=0</span><br></pre></td></tr></table></figure>
<h2 id="kubernetes的ipvs模式和iptables模式"><a href="#kubernetes的ipvs模式和iptables模式" class="headerlink" title="kubernetes的ipvs模式和iptables模式"></a>kubernetes的ipvs模式和iptables模式</h2><h3 id="什么是IPVS？"><a href="#什么是IPVS？" class="headerlink" title="什么是IPVS？"></a>什么是IPVS？</h3><p>IPVS (IP Virtual Server，IP虚拟服务器)是基于Netfilter的、作为linux内核的一部分实现传输层负载均衡的技术，通常称为第4层LAN交换。</p>
<p>IPVS集成在LVS(Linux Virtual Server)中，它在主机中运行，并在真实服务器集群前充当负载均衡器。IPVS可以将对TCP/UDP服务的请求转发给后端的真实服务器，并使真实服务器的服务在单个IP地址上显示为虚拟服务。因此IPVS天然支持Kubernetes Service。</p>
<h3 id="为什么选择IPVS"><a href="#为什么选择IPVS" class="headerlink" title="为什么选择IPVS"></a>为什么选择IPVS</h3><p>随着kubernetes使用量的增长，其资源的可扩展性变得越来越重要。特别是对于使用kubernetes运行大型工作负载的开发人员或者公司来说，service的可扩展性至关重要。</p>
<p>kube-proxy是为service构建路由规则的模块，之前依赖iptables来实现主要service类型的支持，比如(ClusterIP和NodePort)。但是iptables很难支持上万级的service，因为iptables纯粹是为防火墙而设计的，并且底层数据结构是内核规则的列表。</p>
<p>kubernetes早在1.6版本就已经有能力支持5000多节点，这样基于iptables的kube-proxy就成为集群扩容到5000节点的瓶颈。举例来说，如果在一个5000节点的集群，我们创建2000个service，并且每个service有10个pod，那么我们就会在每个节点上有至少20000条iptables规则，这会导致内核非常繁忙。</p>
<p>基于IPVS的集群内负载均衡就可以完美的解决这个问题。IPVS是专门为负载均衡设计的，并且底层使用哈希表这种非常高效的数据结构，几乎可以允许无限扩容。</p>
<h3 id="IPVS-vs-IPTABLES区别"><a href="#IPVS-vs-IPTABLES区别" class="headerlink" title="IPVS vs. IPTABLES区别"></a>IPVS vs. IPTABLES区别</h3><p>IPVS模式在Kubernetes v1.8中引入，并在v1.9中进入了beta。 1.11中实现了GA(General Availability)。IPTABLES模式在v1.1中添加，并成为自v1.2以来的默认操作模式。 IPVS和IPTABLES都基于netfilter。 IPVS模式和IPTABLES模式之间的差异如下：</p>
<ul>
<li>IPVS为大型集群提供了更好的可扩展性和性能。</li>
<li>IPVS支持比iptables更复杂的负载平衡算法（最小负载，最少连接，位置，加权等）。</li>
<li>IPVS支持服务器健康检查和连接重试等。</li>
</ul>
<p><a href="https://blog.csdn.net/fanren224/article/details/86548398">参考1</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/37230013">参考2</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/01/%E5%8D%8E%E4%B8%BA%E4%BA%91%E4%B8%8A%E5%AE%89%E8%A3%85helm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Carlmartin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carlmartin' Blog">
      <meta itemprop="description" content="A place for codeing break.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Carlmartin' Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/01/%E5%8D%8E%E4%B8%BA%E4%BA%91%E4%B8%8A%E5%AE%89%E8%A3%85helm/" class="post-title-link" itemprop="url">华为云上安装helm</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-01 15:16:30" itemprop="dateCreated datePublished" datetime="2019-08-01T15:16:30+08:00">2019-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-06 16:19:03" itemprop="dateModified" datetime="2024-03-06T16:19:03+08:00">2024-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Helm是Kubernetes生态系统中的一个软件包管理工具.</p>
<p>对于应用发布者而言，可以通过Helm打包应用，管理应用依赖关系，管理应用版本并发布应用到软件仓库。</p>
<p>除此以外，Helm还提供了kubernetes上的软件部署，删除，升级，回滚应用的强大功能。</p>
<h2 id="Helm概念"><a href="#Helm概念" class="headerlink" title="Helm概念"></a>Helm概念</h2><ul>
<li>Helm: Kubernetes的应用打包工具，也是命令行工具的名称。</li>
<li>Tiller: Helm的服务端，部署在Kubernetes集群中，用于处理Helm的相关命令。</li>
<li>Chart: Helm的打包格式，内部包含了一组相关的kubernetes资源。</li>
<li>Repoistory: Helm的软件仓库，repository本质上是一个web服务器，该服务器保存了chart软件包以供下载，并有提供一个该repository的chart包的清单文件以供查询。在使用时，Helm可以对接多个不同的Repository。</li>
<li>Release: 使用Helm install命令在Kubernetes集群中安装的Chart称为Release。</li>
</ul>
<p>下图展示这个概念之间的联系:</p>
<p><img src="https://carlmartin-pic-1305764798.cos.ap-chengdu.myqcloud.com/hexo/images/kubeflow_introduce/helm-architecture.png" alt=""></p>
<h2 id="华为云上安装"><a href="#华为云上安装" class="headerlink" title="华为云上安装"></a>华为云上安装</h2><h3 id="Helm安装"><a href="#Helm安装" class="headerlink" title="Helm安装"></a>Helm安装</h3><p>从Github的<a href="https://github.com/helm/helm/releases">发布页</a>或者<a href="https://storage.googleapis.com/kubernetes-helm/helm-v2.11.0-linux-amd64.tar.gz">GoogleCloud</a>下载</p>
<blockquote>
<p>helm v2.11版本在K8s v1.11.7测试通过</p>
</blockquote>
<p>上传到客户端节点后, 解压并将文件拷贝到系统路径之中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf helm-v2.11.0-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">mv</span> linux-amd64/helm /usr/local/bin/helm</span><br></pre></td></tr></table></figure>
<h3 id="Helm初始化"><a href="#Helm初始化" class="headerlink" title="Helm初始化"></a>Helm初始化</h3><p>创建一个tiller的service_account: <code>tiller_service_account.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>
<p>创建角色</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f tiller_service_account.yaml</span><br></pre></td></tr></table></figure>
<p>Helm初始化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm init --service-account tiller --skip-refresh</span><br><span class="line"><span class="comment">## 更新镜像地址, 最好你从官网下载到tiller镜像, 再将镜像传入到华为云的SWR, 此处填写SWR地址</span></span><br><span class="line">helm init --tiller-image swr.cn-north-1.myhuaweicloud.com/hzw/tiller:v2.11.0 --upgrade </span><br></pre></td></tr></table></figure>
<blockquote>
<p>docker tag registry.cn-hangzhou.aliyuncs.com/acs/tiller:v2.11.0 swr.cn-north-1.myhuaweicloud.com/hzw/tiller:v2.11.0</p>
</blockquote>
<p>执行<code>helm version</code>查看结果, 发现<code>Error: could not find a ready tiller pod</code>错误</p>
<p>查找原因</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod --all-namespaces|grep tiller</span><br><span class="line"><span class="comment"># 如果没找到pod, 说明前面的步骤还有问题</span></span><br><span class="line">kubectl describe pod <span class="variable">$Pod_Name</span> -n kube-system</span><br></pre></td></tr></table></figure>
<p>发现问题还是<code>Error: ImagePullBackOff</code></p>
<p>问题和之前一样, 华为云的k8s拉取镜像需要<code>imagePullSecret</code></p>
<p>编辑<code>tiller-deploy</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit deploy tiller-deploy -n kube-system</span><br></pre></td></tr></table></figure>
<p>将以下内容加入到对应的模块之中</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br></pre></td></tr></table></figure>
<p>过段时间之后,发现tiller已经正常</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@/home]<span class="comment"># kubectl get pod -n kube-system|grep tiller</span></span><br><span class="line">tiller-deploy-759d874f-4dgmv     1/1       Running   0          56m</span><br></pre></td></tr></table></figure>
<p>Helm安装和初始化工作已经完成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@gpu-01-client volcano]<span class="comment"># helm version</span></span><br><span class="line">Client: &amp;version.Version&#123;SemVer:<span class="string">&quot;v2.11.0&quot;</span>, GitCommit:<span class="string">&quot;2e55dbe1fdb5fdb96b75ff144a339489417b146b&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:<span class="string">&quot;v2.11.0&quot;</span>, GitCommit:<span class="string">&quot;2e55dbe1fdb5fdb96b75ff144a339489417b146b&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考说明"><a href="#参考说明" class="headerlink" title="参考说明"></a>参考说明</h2><p><a href="https://blog.csdn.net/wzygis/article/details/84346573">安装指南</a></p>
<p><a href="https://support.huaweicloud.com/bestpractice-cce/cce_bestpractice_0024.html">华为云官网指南</a></p>
<p><a href="https://zhaohuabing.com/2018/04/16/using-helm-to-deploy-to-kubernetes/">Helm介绍</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/30/Ubuntu%E4%BD%BF%E7%94%A8Git%E6%8A%A5%E9%94%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Carlmartin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carlmartin' Blog">
      <meta itemprop="description" content="A place for codeing break.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Carlmartin' Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/30/Ubuntu%E4%BD%BF%E7%94%A8Git%E6%8A%A5%E9%94%99/" class="post-title-link" itemprop="url">Ubuntu使用Git报错</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-07-30 15:00:27" itemprop="dateCreated datePublished" datetime="2019-07-30T15:00:27+08:00">2019-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-06 16:19:03" itemprop="dateModified" datetime="2024-03-06T16:19:03+08:00">2024-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>754</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近使用公司的开发机器(ubuntu系统), 执行<code>git clone</code>一直会出现如下错误:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: RPC failed; curl 56 GnuTLS recv error (-110): The TLS connection was non-properly terminated.</span><br></pre></td></tr></table></figure></p>
<p>据说产生这个错误的原因, ubuntu上使用的https认证组件有问题, 使用如下步骤可以解决该问题.</p>
<p>大部分的内容参考自<a href="https://zhuanlan.zhihu.com/p/53961303">这篇博客</a>,但是文章的步骤在公司的机器还是有一些问题,我会注明.</p>
<p><strong>安装必要依赖</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential fakeroot dpkg-dev</span><br><span class="line">sudo apt-get install libcurl4-openssl-dev</span><br></pre></td></tr></table></figure></p>
<p><strong>下载源码并重新编译安装</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建临时目录</span></span><br><span class="line"><span class="built_in">mkdir</span> ~/git-rectify</span><br><span class="line"><span class="built_in">cd</span> ~/git-rectify</span><br><span class="line"><span class="comment"># 下载源码</span></span><br><span class="line">apt-get <span class="built_in">source</span> git</span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">apt-get build-dep git</span><br><span class="line"><span class="comment"># 进入源码目录</span></span><br><span class="line"><span class="built_in">cd</span> git-2*</span><br><span class="line"><span class="comment"># 修改配置文件</span></span><br><span class="line">sed -i -- <span class="string">&#x27;s/libcurl4-gnutls-dev/libcurl4-openssl-dev/&#x27;</span> ./debian/control</span><br><span class="line">sed -i -- <span class="string">&#x27;/TEST\s*=\s*test/d&#x27;</span> ./debian/rules</span><br><span class="line"><span class="comment"># 重新编译(注意要加入`-uc -us`,不然会出现`secret key not available`错误)</span></span><br><span class="line">dpkg-buildpackage -rfakeroot -b -uc -us</span><br><span class="line"><span class="comment"># 返回上一级,重新安装</span></span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">dpkg -i git_2*.deb</span><br></pre></td></tr></table></figure></p>
<p><strong>锁住git不更新</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果不锁定, 下次更新git的时候, 会重新覆盖</span></span><br><span class="line">sudo apt-mark hold git</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/30/%E8%93%9D%E7%BB%BF%E5%8F%91%E5%B8%83-%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83%E5%92%8CAB%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Carlmartin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carlmartin' Blog">
      <meta itemprop="description" content="A place for codeing break.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Carlmartin' Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/30/%E8%93%9D%E7%BB%BF%E5%8F%91%E5%B8%83-%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83%E5%92%8CAB%E6%B5%8B%E8%AF%95/" class="post-title-link" itemprop="url">蓝绿发布/灰度发布和AB测试</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-07-30 09:37:34" itemprop="dateCreated datePublished" datetime="2019-07-30T09:37:34+08:00">2019-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-06 16:19:03" itemprop="dateModified" datetime="2024-03-06T16:19:03+08:00">2024-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>之前想做过一个多版本发布的系统,  当时了解了不少微服务部署的概念, 其中就包括蓝绿发布, 灰度发布以及AB测试.</p>
<p>但是当时对这些概念理会的不是很深, 大致认为他们都是差不多的东西. 这次研究ServiceMesh的时候, 这些概念又出现了, 所以现在写个文章把这些概念理清楚.</p>
<blockquote>
<p>内容不少节选自<a href="https://cloud.tencent.com/developer/article/1449209">这篇文章</a>和<a href="http://www.bewindoweb.com/231.html">这篇文章</a></p>
</blockquote>
<h2 id="蓝绿发布"><a href="#蓝绿发布" class="headerlink" title="蓝绿发布"></a>蓝绿发布</h2><blockquote>
<p>蓝绿部署中，一共有两套系统：一套是正在提供服务系统，标记为“绿色”；另一套是准备发布的系统，标记为“蓝色”。两套系统都是功能完善的，并且正在运行的系统，只是系统版本和对外服务情况不同。</p>
</blockquote>
<p>蓝绿发布最大的特点就是: </p>
<ol>
<li><strong>两套运行环境</strong></li>
<li><strong>流量一把切</strong></li>
</ol>
<p>特别要注意的, 两套运行环境只要是指<strong>无状态服务</strong>那个一部分,  对于原数据库或者其他有状态的实例, 始终使用的都是同一套系统.</p>
<blockquote>
<p>如果想要将这些<strong>有状态实例</strong>进行切换, 必须保证数据同步的, 这样来就必然会涉及到了CAP理论, 整个系统复杂性就高了.</p>
</blockquote>
<h2 id="灰度发布"><a href="#灰度发布" class="headerlink" title="灰度发布"></a>灰度发布</h2><blockquote>
<p>灰度发布又叫做<strong>金丝雀发布</strong>，以前矿工下矿洞前，会放一只金丝雀去试探是否有瓦斯（金丝雀对瓦斯很敏感），映射到这里就是先发布一小部分来试探整体是否能够正常运行，如果能正常运行则进行完全部署的发布方式，目前仍然是不少成长型技术组织的主流发布方式</p>
</blockquote>
<p>灰度发布最大特点是:</p>
<ol>
<li>流量渐切</li>
<li>影响可控</li>
</ol>
<p>蓝绿发布的时候, <strong>流量一把切</strong>导致变更出现严重bug的时候, 是无法评估影响的, 因为你无法知道变更时间窗口之中, 有多少用户使用了你的服务.</p>
<p>而灰度发布可以指定新版本的用户, 收集<strong>金丝雀</strong>的反馈意见, 然后进行决策是否放开流程, 或者回退版本.</p>
<h2 id="A-B测试"><a href="#A-B测试" class="headerlink" title="A/B测试"></a>A/B测试</h2><blockquote>
<p>A/B测试指的是同时上线V1和V2版本，根据一定条件将流量分别导入V1和V2版本，收集感兴趣的数据，来对比产品功能的效果。</p>
</blockquote>
<p>A/B测试经常会和灰度发布在一起说, 因为:</p>
<ol>
<li>两者都有多个版本(蓝绿发布一般只有两个版本, 而灰度可以存在多个版本)</li>
<li>两者都有流量路由控制</li>
</ol>
<p>但是A/B测试是一种测试方法, <strong>关注的是旧版本和新版本的效果好坏，比如流量转化率、用户体验等等</strong><br>因此, 两者不是一个维度的事情, 只是一般合起来使用: 应用通过<strong>灰度发布</strong>, 然后进行<strong>A/B测试</strong>,发现问题, 进行改进.</p>
<p>游戏领域经常有<strong>内测活动</strong>或者<strong>体验服</strong>, 是一个典型的A/B测试</p>
<blockquote>
<p>A/B测试存在的问题是<strong>金丝雀可能会死</strong>, 因此还有一种通过<strong>流量回放</strong>技术做的测试方法, 将现网的流程全部回放, 测试新版本的时候将现网的业务全部测试一遍. 但这种技术实现复杂, 因为客户的应用不一定全是幂等的, 所以必须同步备份数据库以及运行环境, 还得有环境版本控制. 总之, 不是那种质量非常高的应用, 一般不会去搞这么一套系统的.</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>比较两种发布模式:</p>
<ol>
<li>蓝绿发布的实现更加简单, 但是部署资源占用多, 并且影响不可控</li>
<li>灰度发布的实现确实复杂, 但影响小, 部署也可以采用滚动升级的方式</li>
</ol>
<p>现在一般大多采用灰度发布为多.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Carlmartin</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">186k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:49</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
